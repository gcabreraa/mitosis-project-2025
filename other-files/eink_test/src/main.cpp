#include <GxEPD2_BW.h>
#include <Adafruit_GFX.h>    // Core graphics library
#include <Fonts/FreeMonoBold12pt7b.h>
#include <Fonts/FreeSerif9pt7b.h>
#include <Fonts/FreeMonoBold9pt7b.h>

  #define BUSY_PIN       3
  #define RST_PIN        2
  #define DC_PIN         19
  #define CS_PIN         9
  #define SCL_PIN        4
  #define SDA_PIN        6

// GxEPD2_BW<GxEPD2_420_GDEY042T81, GxEPD2_420_GDEY042T81::HEIGHT> display(
// GxEPD2_420_GDEY042T81(CS_PIN, DC_PIN, RST_PIN, BUSY_PIN));

// 'efpi-21', 100x100px
const unsigned char epd_bitmap_efpi_21 [] PROGMEM = {
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xf0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xf0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xf0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xf0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0xff, 
	0xe0, 0x00, 0x03, 0xfc, 0x1f, 0x9f, 0x80, 0x0c, 0x00, 0x00, 0x7f, 0xf0, 0xff, 0xe0, 0x00, 0x03, 
	0xfc, 0x1f, 0x1f, 0x80, 0x1c, 0x00, 0x00, 0x7f, 0xf0, 0xff, 0xe2, 0xaa, 0xa3, 0xf2, 0xa7, 0xdd, 
	0x41, 0x0c, 0x55, 0x54, 0x7f, 0xf0, 0xff, 0xe7, 0xff, 0xe7, 0xe3, 0xe3, 0xfc, 0x73, 0x9c, 0x7f, 
	0xfc, 0x7f, 0xf0, 0xff, 0xe3, 0xff, 0xe3, 0xe3, 0xe3, 0xfc, 0x63, 0x8c, 0x7f, 0xfe, 0x7f, 0xf0, 
	0xff, 0xe7, 0x00, 0xe3, 0xe3, 0xff, 0x83, 0x9f, 0x9c, 0x70, 0x1c, 0x7f, 0xf0, 0xff, 0xe3, 0x00, 
	0xe3, 0xe7, 0xff, 0x03, 0x8f, 0x8c, 0x70, 0x0e, 0x7f, 0xf0, 0xff, 0xe7, 0x00, 0xe7, 0xe3, 0xff, 
	0x83, 0x9f, 0x1c, 0x60, 0x0c, 0x7f, 0xf0, 0xff, 0xe3, 0x00, 0xe3, 0xe0, 0x1c, 0x7f, 0xe0, 0x0c, 
	0x70, 0x1e, 0x7f, 0xf0, 0xff, 0xe7, 0x00, 0xe3, 0xe0, 0x1c, 0xff, 0xf0, 0x1c, 0x70, 0x0c, 0x7f, 
	0xf0, 0xff, 0xe3, 0x00, 0xe3, 0xe2, 0x94, 0xff, 0xa1, 0x5c, 0x60, 0x0e, 0x7f, 0xf0, 0xff, 0xe7, 
	0x00, 0xe7, 0xe3, 0xe3, 0xff, 0x83, 0xfc, 0x70, 0x1c, 0x7f, 0xf0, 0xff, 0xe3, 0x00, 0xe3, 0xe3, 
	0xe3, 0xff, 0x83, 0xfc, 0x70, 0x0e, 0x7f, 0xf0, 0xff, 0xe7, 0xff, 0xe3, 0x9c, 0xe3, 0xeb, 0xec, 
	0x1c, 0x7f, 0xfc, 0x7f, 0xf0, 0xff, 0xe3, 0xff, 0xe3, 0x1c, 0x63, 0xe3, 0xfc, 0x1c, 0x7f, 0xfc, 
	0x7f, 0xf0, 0xff, 0xe7, 0xff, 0xe7, 0x1c, 0xe3, 0xe3, 0xfc, 0x0c, 0x7f, 0xfe, 0x7f, 0xf0, 0xff, 
	0xe0, 0x00, 0x03, 0x9c, 0x63, 0x9c, 0x63, 0x9c, 0x00, 0x00, 0x7f, 0xf0, 0xff, 0xe0, 0x00, 0x03, 
	0x1c, 0xe3, 0x1c, 0x73, 0x8c, 0x00, 0x00, 0x7f, 0xf0, 0xff, 0xe2, 0x22, 0x27, 0x94, 0x6b, 0x9d, 
	0x63, 0x9e, 0xa4, 0x44, 0x7f, 0xf0, 0xff, 0xff, 0xff, 0xff, 0xe0, 0x1c, 0x7f, 0x83, 0x8f, 0xff, 
	0xff, 0xff, 0xf0, 0xff, 0xff, 0xff, 0xff, 0xe0, 0x1c, 0xff, 0x83, 0x9f, 0xff, 0xff, 0xff, 0xf0, 
	0xff, 0xef, 0xeb, 0x97, 0xad, 0xa5, 0x24, 0xab, 0xa7, 0xaf, 0xff, 0xff, 0xf0, 0xff, 0xe3, 0xe7, 
	0x03, 0x1f, 0xe3, 0x80, 0x7f, 0xf3, 0x8f, 0xff, 0xff, 0xf0, 0xff, 0xe7, 0xe3, 0x03, 0x9f, 0xe3, 
	0x00, 0x7f, 0xe3, 0x9f, 0xff, 0xff, 0xf0, 0xff, 0xe0, 0xfc, 0x1f, 0xe0, 0xfc, 0xfc, 0xff, 0x9c, 
	0x0c, 0x7e, 0x7f, 0xf0, 0xff, 0xe0, 0xf8, 0x1f, 0xe0, 0x7c, 0x7c, 0x7f, 0x8c, 0x0e, 0x7c, 0x7f, 
	0xf0, 0xff, 0xe0, 0xfc, 0x9f, 0xe0, 0xfc, 0x7c, 0x7f, 0x1e, 0x1c, 0x7c, 0x7f, 0xf0, 0xff, 0xe0, 
	0xe3, 0xe0, 0x63, 0x1c, 0x1c, 0x0c, 0x7f, 0x80, 0x03, 0xff, 0xf0, 0xff, 0xe0, 0xe7, 0xe0, 0xe3, 
	0x9c, 0x1c, 0x1c, 0x7f, 0x80, 0x01, 0xff, 0xf0, 0xff, 0xe0, 0x03, 0xaa, 0xa3, 0x1c, 0x5c, 0x5c, 
	0x75, 0x00, 0x03, 0xff, 0xf0, 0xff, 0xe0, 0x07, 0x1f, 0x03, 0x9c, 0x7c, 0x7c, 0x70, 0x00, 0x01, 
	0xff, 0xf0, 0xff, 0xe0, 0x03, 0x1f, 0x83, 0x1c, 0xfc, 0x7c, 0x60, 0x00, 0x03, 0xff, 0xf0, 0xff, 
	0xff, 0x00, 0xe0, 0xfc, 0x03, 0x00, 0x1f, 0x9c, 0x7c, 0x60, 0x7f, 0xf0, 0xff, 0xff, 0x00, 0xe0, 
	0x7c, 0x03, 0x80, 0x1f, 0x8c, 0x7c, 0x70, 0x7f, 0xf0, 0xff, 0xff, 0x00, 0xe0, 0xfc, 0x03, 0x00, 
	0x0f, 0x9c, 0x7c, 0x70, 0x7f, 0xf0, 0xff, 0xe3, 0xfc, 0x1f, 0x18, 0x1c, 0x1f, 0x80, 0x0f, 0x8f, 
	0x8f, 0xff, 0xf0, 0xff, 0xe7, 0xfc, 0x1f, 0x9c, 0x1c, 0x1f, 0x80, 0x1f, 0x8f, 0x8f, 0xff, 0xf0, 
	0xff, 0xe5, 0xf4, 0xaf, 0x1d, 0x08, 0x1f, 0x8a, 0x9e, 0xaf, 0x8d, 0xff, 0xf0, 0xff, 0xf8, 0xe3, 
	0xe3, 0x1f, 0x80, 0x1f, 0x9f, 0xfc, 0x71, 0x80, 0x7f, 0xf0, 0xff, 0xfc, 0xe7, 0xe3, 0x9f, 0x00, 
	0x1f, 0x0f, 0xfc, 0x73, 0x80, 0x7f, 0xf0, 0xff, 0xf8, 0xf4, 0x2c, 0x1f, 0x9f, 0xc3, 0x9f, 0x9f, 
	0x80, 0xe1, 0xff, 0xf0, 0xff, 0xfc, 0xf8, 0x1c, 0x1f, 0x1f, 0xe3, 0x9f, 0x8f, 0x80, 0x73, 0xff, 
	0xf0, 0xff, 0xf8, 0xfc, 0x18, 0x1f, 0x9f, 0xe3, 0x8f, 0x9f, 0x80, 0x71, 0xff, 0xf0, 0xff, 0xff, 
	0x00, 0x00, 0xe0, 0x1c, 0x73, 0x9f, 0x8f, 0xfc, 0x63, 0xff, 0xf0, 0xff, 0xff, 0x00, 0x00, 0xe0, 
	0x1c, 0x63, 0x8f, 0x9f, 0xfe, 0x73, 0xff, 0xf0, 0xff, 0xff, 0x22, 0x4a, 0x60, 0x14, 0x6a, 0x9f, 
	0x8d, 0xdc, 0x71, 0xff, 0xf0, 0xff, 0xf8, 0xff, 0xff, 0x00, 0xe0, 0x1c, 0x63, 0x80, 0x0f, 0xfe, 
	0x7f, 0xf0, 0xff, 0xfc, 0xff, 0xff, 0x80, 0x60, 0x1c, 0x73, 0x80, 0x1f, 0xfc, 0x7f, 0xf0, 0xff, 
	0xea, 0x97, 0xeb, 0x14, 0x5b, 0x1c, 0x43, 0x81, 0xa5, 0x74, 0x7f, 0xf0, 0xff, 0xe3, 0x03, 0xe3, 
	0x1c, 0x1f, 0x8c, 0x03, 0x83, 0xf0, 0x70, 0x7f, 0xf0, 0xff, 0xe7, 0x07, 0xe7, 0x9c, 0x1f, 0x1c, 
	0x03, 0x83, 0xf0, 0x70, 0x7f, 0xf0, 0xff, 0xff, 0xff, 0x18, 0x00, 0x03, 0x83, 0x9f, 0x03, 0x8f, 
	0xf0, 0x7f, 0xf0, 0xff, 0xff, 0xff, 0x1c, 0x00, 0x03, 0x83, 0x8f, 0x83, 0x8f, 0xe0, 0x7f, 0xf0, 
	0xff, 0xff, 0xff, 0x98, 0x00, 0x03, 0x03, 0x9f, 0x81, 0x9f, 0xf0, 0x7f, 0xf0, 0xff, 0xe3, 0x03, 
	0xe0, 0x03, 0x83, 0xff, 0xff, 0x80, 0x01, 0x8f, 0xff, 0xf0, 0xff, 0xe7, 0x07, 0xe0, 0x03, 0x03, 
	0xff, 0xff, 0x80, 0x03, 0x8f, 0xff, 0xf0, 0xff, 0xeb, 0xab, 0xea, 0x03, 0xc3, 0xbe, 0xff, 0x8a, 
	0xa3, 0x8a, 0xff, 0xf0, 0xff, 0xff, 0xff, 0xff, 0x83, 0xe3, 0x9c, 0x7f, 0x9f, 0xf3, 0x80, 0x7f, 
	0xf0, 0xff, 0xff, 0xff, 0xff, 0x03, 0xe3, 0x1c, 0x7f, 0x8f, 0xe1, 0x80, 0x7f, 0xf0, 0xff, 0xe0, 
	0x00, 0x07, 0xff, 0x9f, 0xfc, 0x1f, 0x9c, 0xf3, 0xe3, 0xff, 0xf0, 0xff, 0xe0, 0x00, 0x03, 0xff, 
	0x1f, 0xfc, 0x1f, 0x8c, 0x73, 0xf1, 0xff, 0xf0, 0xff, 0xe1, 0x24, 0x87, 0xff, 0x9f, 0xfc, 0x1f, 
	0x9c, 0x63, 0xf3, 0xff, 0xf0, 0xff, 0xe7, 0xff, 0xe3, 0x1f, 0x1f, 0x9f, 0xe3, 0x8f, 0xf1, 0x8c, 
	0x7f, 0xf0, 0xff, 0xe3, 0xff, 0xe3, 0x9f, 0x9f, 0x0f, 0xf3, 0x9f, 0xf3, 0x8e, 0x7f, 0xf0, 0xff, 
	0xe7, 0xb6, 0xe7, 0x5f, 0x1f, 0xbe, 0xcb, 0x8b, 0x43, 0xac, 0x7f, 0xf0, 0xff, 0xe3, 0x00, 0xe3, 
	0xff, 0x9f, 0xfc, 0x1f, 0x80, 0x03, 0xfe, 0x7f, 0xf0, 0xff, 0xe7, 0x00, 0xe3, 0xff, 0x1f, 0xfc, 
	0x0f, 0x80, 0x03, 0xfc, 0x7f, 0xf0, 0xff, 0xe3, 0x00, 0xe3, 0x92, 0xdf, 0xff, 0x1c, 0x6c, 0x60, 
	0x73, 0x7f, 0xf0, 0xff, 0xe7, 0x00, 0xe7, 0x00, 0x7f, 0xff, 0x9c, 0x7c, 0x70, 0x73, 0xff, 0xf0, 
	0xff, 0xe3, 0x00, 0xe3, 0x00, 0xff, 0xff, 0x8c, 0xfc, 0x70, 0x71, 0xff, 0xf0, 0xff, 0xe7, 0x00, 
	0xe3, 0xe0, 0x00, 0x1f, 0x1f, 0x9f, 0xe0, 0x7e, 0x7f, 0xf0, 0xff, 0xe3, 0x00, 0x63, 0xe0, 0x00, 
	0x1f, 0x9f, 0x8f, 0xf0, 0x7c, 0x7f, 0xf0, 0xff, 0xe7, 0xa4, 0xe7, 0xe0, 0x12, 0x4e, 0x8f, 0x1f, 
	0xd0, 0xfc, 0x7f, 0xf0, 0xff, 0xe3, 0xff, 0xe3, 0xe0, 0xff, 0xe0, 0x1c, 0x0c, 0x03, 0xf3, 0xff, 
	0xf0, 0xff, 0xe7, 0xff, 0xe3, 0xe0, 0x7f, 0xe0, 0x0c, 0x1c, 0x03, 0xe1, 0xff, 0xf0, 0xff, 0xe1, 
	0x55, 0x43, 0xad, 0xab, 0xf8, 0x1e, 0x85, 0x00, 0xf3, 0xff, 0xf0, 0xff, 0xe0, 0x00, 0x07, 0x1f, 
	0x03, 0xfc, 0x1f, 0x83, 0x80, 0x71, 0xff, 0xf0, 0xff, 0xe0, 0x00, 0x03, 0x9f, 0x83, 0xfc, 0x0f, 
	0x83, 0x80, 0x73, 0xff, 0xf0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xf0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xf0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xf0
};

// Array of all bitmaps for convenience. (Total bytes used to store images in PROGMEM = 1328)
const int epd_bitmap_allArray_LEN = 1;
const unsigned char* epd_bitmap_allArray[1] = {
	epd_bitmap_efpi_21
};


GxEPD2_BW<GxEPD2_290_GDEY029T94, GxEPD2_290_GDEY029T94::HEIGHT> display(
GxEPD2_290_GDEY029T94(CS_PIN, DC_PIN, RST_PIN, BUSY_PIN));

const char monitor[] = "MITOS Heat Monitor Project";
const char website[] = "efpi-21.mit.edu";

unsigned long lastUpdate = 0;
const unsigned long interval = 20000; // 20 seconds
bool showFirst = true;

int x = (display.width() - 80) / 2;
int y = (display.height() - 80) / 2;

void qrCode()
{
  display.setFullWindow();
  display.firstPage();
  do {
    display.fillScreen(GxEPD_WHITE);
    display.drawBitmap(x, y, epd_bitmap_efpi_21, 100, 100, GxEPD_BLACK);
  } while (display.nextPage());
}

void mitosProject()
{
  display.setRotation(1);
  display.setFont(&FreeMonoBold9pt7b);
  display.setTextColor(GxEPD_BLACK);
  int16_t tbx, tby; uint16_t tbw, tbh;
  display.getTextBounds(monitor, 0, 0, &tbx, &tby, &tbw, &tbh);
  // center the bounding box by transposition of the origin:
  uint16_t x = ((display.width() - tbw) / 2) - tbx;
  uint16_t y = ((display.height() - tbh) / 2) - tby;
  display.setFullWindow();
  display.firstPage();
  do
  {
    display.fillScreen(GxEPD_WHITE);
    display.setCursor(x, y);
    display.print(monitor);
  }
  while (display.nextPage());
}

void showMessage(const char* msg) {
  display.setRotation(1);
  display.setFont(&FreeMonoBold9pt7b);
  display.setTextColor(GxEPD_BLACK);

  int16_t tbx, tby;
  uint16_t tbw, tbh;
  display.getTextBounds(msg, 0, 0, &tbx, &tby, &tbw, &tbh);
  uint16_t x = ((display.width() - tbw) / 2) - tbx;
  uint16_t y = ((display.height() - tbh) / 2) - tby;

  display.setFullWindow();
  display.firstPage();
  do {
    display.fillScreen(GxEPD_WHITE);
    display.setCursor(x, y);
    display.print(msg);
  } while (display.nextPage());
}

void setup()
{
  pinMode(CS_PIN,OUTPUT);
  pinMode(DC_PIN,OUTPUT);
  pinMode(RST_PIN,OUTPUT);
  //pinMode(BUSY_PIN,OUTPUT);
  //display.init(115200); // default 10ms reset pulse, e.g. for bare panels with DESPI-C02
  display.init(115200, true, 2, false); // USE THIS for Waveshare boards with "clever" reset circuit, 2ms reset pulse
  //mitosProject();
  //lastUpdate = millis();
  qrCode();
  display.hibernate();
}

void loop() {
  // unsigned long currentMillis = millis();
  // if (currentMillis - lastUpdate >= interval) {
  //   lastUpdate = currentMillis;
  //   showFirst = !showFirst;
  //   showMessage(showFirst ? monitor : website);
  // }
}